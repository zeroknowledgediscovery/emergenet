\documentclass[onecolumn,10pt]{IEEEtran}
\let\labelindent\relax
\usepackage{enumitem}
\input{preamble.tex} 

\pagestyle{fancy}
\rhead{\footnotesize\bf\sffamily\thepage}
\cfoot{}
%\cfoot{\scriptsize For Nature Letter \today}
%--------------
\externaldocument[SI-]{SI}
\externaldocument[main-]{main}
%--------------
\input{customdef}

\title{Supplementary Text: \\ \TITLE} 

\tikzXtrue
%\tikzXfalse
%\pgfplotsset{compat=1.18} 
\begin{document} 
\maketitle   


   


\section*{Supplementary Methods: Notes on q-Distance \& Supporting Results}

The \textit{q-distance} is a pseudo-metric since  distinct sequences can induce the same distributions over each index, and thus evaluate to have a zero distance. This is  actually desirable; we do not want our distance to be  sensitive to changes that are not biologically relevant. The intuition is that  not all sequence variations brought about by substitutions are equally important or likely. Even with no  selection pressure, we might still see random  variations at an index if such variations do not affect the replicative fitness. Under that scenario, the corresponding $\Phi_i$ will predict a flat distribution no matter what the input sequence is, thus contributing nothing to the overall distance. And even if two strains $x,y$ have the same entry at some index $i$, the remaining residues  might induce different distributions $\Phi_i$ based on the remote dependencies, $i.e.$, the entries in $x_{-i},y_{-i}$. Also, it matters if the sequences come from two different background populations $P,Q$, $i.e.$, if the induced Qnets $\Phi^P,\Phi^Q$ are different. Thus, if we construct Qnets for H1N1 Influenza A separately for the collection years 2008 and 2009, then the same exact sequence collected in the respective years might have a non-zero distance between them, reflecting the fact that the background population the sequences arose from are different, inducing possibly different expected mutational tendencies (See SI-Table~\ref{SI-tabex}).

Next, we induce q-distance  between a sequence and a population and between two populations.
\begin{defn}[Pseudo-metric between populations]
Using the notion of Hausdorff metric between sets:
\cgather{
\forall x \in P, y \in Q, \notag \\ \theta(x,Q) = \min_{y \in Q} \theta(x,y)\\
\theta(P,Q) =  \max \left \{ \max_{x \in P} \theta(x,Q) ,\max_{y \in Q} \theta(y,P) 
\right \} }
\end{defn}





\subsection*{In-silico Corroboration of \qnet Constraints}

We carry out in-silico experiments to corroborate that the constraints represented within an inferred \qnet are indeed reflective of the  biology in play. We compare the results of simulated mutational perturbations to sequences from our databases (for which we have already constructed \qnet{s}), and then use NCBI BLAST (\href{https://blast.ncbi.nlm.nih.gov/Blast.cgi}{https://blast.ncbi.nlm.nih.gov/Blast.cgi}) to identify  if  our perturbed sequences match with existing sequences in the databases (See  SI-Fig.~\ref{SI-figsoa}). We find that in contrast to random variations, which rapidly diverge the trajectories, the \qnet constraints tend to produce smaller variance in the trajectories, maintain a high degree of match as we extend our trajectories, and produces matches closer in time to the collection time of the  initial sequence | suggesting that the \qnet  does indeed capture realistic constraints.





\subsection*{Significance Test for Population Membership}

For our modeling to be reliable, we need a quantitative test of how well the \qnet represents the data. Here, we formulate an explicit membership test to ascertain if individual samples may indeed be generated by the \qnet with sufficiently high probability.
%
\begin{defn}[Membership probability of a sequence]\label{defmem}
Given a population $P$ inducing the \qnet $\Phi^P$ and a sequence $x$, we can compute the membership probability of $x$:
\cgather{
\mem{x}^P \triangleq Pr(x \in P) = \prod_{j=1}^N \left ( \Phi^P_j(x_{-j}) \vert_{x_j} \right )
}
\end{defn}
$x_j$ is the $j^{th}$ entry in $x$, and is thus an element in the set $\Sigma_j$. Since we are mostly concerned with the case where $\Sigma_j$ is a finite set, $\Phi^P_j(x_{-j}) \vert_{x_j}$ is the entry in the probability mass function corresponding to the element of $\Sigma_j$ which appears at the  $j^{th}$ index in sequence $x$. 
 
We can carry out this calculation for a sequence $x$  known to be in the population $P$ as well, which allows us to define the membership degree $\M^P_x$.
\begin{defn}[Membership degree]
Let $X$ be a random field representing a population $P$, $ie.$. $X=x$ is a randomly drawn sequence from $P$. Then  the membership degree $\M^P$ is  a function of the random variable $X$: 
\cgather{
\M^P(X)  \triangleq  \prod_{j=1}^N \left ( \Phi^P_j(X_{-j}) \vert_{X_j} \right )
}Note that $\M^P$ takes values in the unit interval $[0,1]$, and the probability  $x$ is a member of the population $P$ is $\M^P(X=x)$, denoted briefly as $\mem{x}^P$ or $\mem{x}$ if $P$ is clear from context.
\end{defn}
Since $\M^P(X)$ is a random variable, we can now compute sets of sequences that better represent the population $P$, and ones that are on the fringe. We can also evaluate using a pre-specified significance-level if a particular sequence is not from the population $P$, thus identifying if  we need to recompute the predictors $\Phi$, or split the base population. We can set up a hypothesis testing scenario to determine if sequences are indeed from a test population, as follows:

Given a population P, inducing a \qnet $\Phi^P$, and a sequence $x$, we assume the null hypothesis is $x \notin P$. We reject the null hypothesis at a pre-specified significance  $\alpha$, if 
\cgather{ Pr(\M^P(X) \geqq \M^P(X=x)) \leqq \alpha
}The fraction of newly observed  sequences that do not reject the null hypothesis can then be used as an estimate of the species-specific divergence  in  population characteristics.





\subsection*{Proof of Probability Bounds}\label{sec:appendix}

\begin{thm}[Probability bound]\label{thmbnd}
Given a sequence  $x$ of length $N$ that transitions  to a strain $y\in Q$, we have the following bounds at significance level $\alpha$.
\cgather{
\mem{y}^Q e^{ \frac{\sqrt{8}N^2}{1-\alpha}\theta(x,y)} \geqq Pr(x \rightarrow y) \geqq \mem{y}^Q e^{-\frac{\sqrt{8}N^2}{1-\alpha}\theta(x,y)}
  }%
  where $\mem{y}^Q$ is the membership probability of strain $y$ in the target population $Q$ (See Def.~\ref{defmem}), and $\theta(x,y)$ is the q-distance between $x,y$ (See Def.~\ref{main-defqdistance} in \qnet Framework).
\end{thm}
\begin{proof}
Using Sanov's theorem~\cite{cover} on large deviations, we conclude that the probability of spontaneous jump from strain $x\in P$ to strain $y\in Q$, with the possibility $P \neq Q$, is given by:
\cgather{\label{eq29}
  Pr(x\rightarrow y) =\prod_{i=1}^N \left ( \Phi^P_i(x_{-i}) \vert_{y_i} \right )
}
Writing the factors on the right hand side as:
\cgather{
 \Phi^P_i(x_{-i}) \vert_{y_i} =  \Phi^Q_i(y_{-i}) \vert_{y_i} \left (  \frac{\Phi^P_i(x_{-i}) \vert_{y_i}}{\Phi^Q_i(y_{-i}) \vert_{y_i}}  \right )
}%
we note that $\Phi^P_i(x_{-i})$, $\Phi^Q_i(y_{-i})$ are distributions on the same index $i$, and hence:
  \cgather{
\vert  \Phi^P_i(x_{-i})_{y_i} - \Phi^Q_i(y_{-i})_{y_i}\vert \leqq \sum_{y_i \in \Sigma_i} \vert  \Phi^P_i(x_{-i})_{y_i} - \Phi^Q_i(y_{-i})_{y_i}\vert 
}%
Using a standard refinement of Pinsker's inequality~\cite{fedotov2003refinements}, and the relationship of Jensen-Shannon divergence with  total variation, we get:
\cgather{
  \theta_i \geqq \frac{1}{8} \vert  \Phi^P_i(x_{-i})_{y_i} - \Phi^Q_i(y_{-i})_{y_i}\vert^2
\Rightarrow \left   \lvert  1  - \frac{\Phi^Q_i(y_{-i})_{y_i}}{\Phi^P_i(x_{-i})_{y_i}} \right \rvert \leqq \frac{1}{a_0}\sqrt{8 \theta_i}
}%
where $a_0$ is the smallest non-zero probability value of generating the entry at any index. We will see that this parameter is related to statistical significance of our bounds. First, we can formulate a lower bound as follows:
\cgather{\label{eqLB}
 \log \left  ( \prod_{i=1}^N   \frac{\Phi^P_i(x_{-i}) \vert_{y_i}}{\Phi^Q_i(y_{-i}) \vert_{y_i}}  \right )
  = \sum_i \log  \left  (  \frac{\Phi^P_i(x_{-i}) \vert_{y_i}}{\Phi^Q_i(y_{-i}) \vert_{y_i}}  \right )
\geqq \sum_i \left  ( 1- \frac{\Phi^Q_i(y_{-i})_{y_i}}{\Phi^P_i(x_{-i})_{y_i}} \right ) \geqq  \frac{\sqrt{8}}{a_0}\sum_i\theta_i^{1/2} = -\frac{\sqrt{8}N}{a_0}\theta
}%
Similarly,  the upper bound may be derived as:
\cgather{\label{eqUB}
\log \left  ( \prod_{i=1}^N   \frac{\Phi^P_i(x_{-i}) \vert_{y_i}}{\Phi^Q_i(y_{-i}) \vert_{y_i}}  \right )
  = \sum_i \log  \left  (  \frac{\Phi^P_i(x_{-i}) \vert_{y_i}}{\Phi^Q_i(y_{-i}) \vert_{y_i}}  \right ) \leqq \sum_i \left  ( \frac{\Phi^Q_i(y_{-i})_{y_i}}{\Phi^P_i(x_{-i})_{y_i}} - 1 \right ) \leqq \frac{\sqrt{8}N}{a_0}\theta
}%
Combining Eqs.~\ref{eqLB} and \ref{eqUB}, we conclude:
\cgather{
\mem{y}^Q e^{ \frac{\sqrt{8}N}{a_0}\theta} \geqq Pr(x \rightarrow y) \geqq \mem{y}^Q e^{-\frac{\sqrt{8}N}{a_0}\theta}
}%
Now, interpreting $a_0$ as the probability of generating an unlikely event below our desired threshold ($i.e.$ a ``failure''), we note that the probability of generating at least one such event is given by $1-(1-a_0)^N$. Hence if $\alpha$ is the pre-specified significance level, we have for $N >> 1 $:
\cgather{
 a_0 \approx (1 -\alpha)/N
}%
Hence, we conclude, that at significance level $\geqq \alpha$, we have the bounds:
\cgather{
\mem{y}^Q e^{ \frac{\sqrt{8}N^2}{1-\alpha}\theta} \geqq Pr(x \rightarrow y) \geqq \mem{y}^Q e^{-\frac{\sqrt{8}N^2}{1-\alpha}\theta}
  }%
\end{proof}
\begin{rem}
This bound can be rewritten in terms of the log-likelihood of the spontaneous jump and  constants independent of the  initial sequence $x$ as:
\cgather{
\left \lvert \log Pr(x \rightarrow y) -C_0 \right \vert \leqq C_1 \theta
}%
where the constants are given by:
\calign{
C_0 &= \log \mem{y}^Q \\
C_1 &= \frac{\sqrt{8} N^2}{1-\alpha}
}%
\end{rem}





\subsection*{Multivariate Regression to Identify Factors in Strain Prediction}

We investigate the key factors that contribute to our successful prediction of the dominant strain in the next season. We carry out a multivariate regression with data diversity, the complexity of inferred \qnet and the edit distance of the WHO recommendation from the dominant strain as independent variables. Here we define data diversity as the number of clusters we have in the input set of sequences, such that any two sequences five or less mutations apart are in the same cluster. \qnet complexity is measured by the number of decision nodes in the component decision trees of the recursive forest.

We select several plausible structures of the regression equation, and in each case conclude that  data diversity has the most important and statistically significant contribution (See SI-Tab.~\ref{tabreg}).

\bibliographystyle{vancouver}
\bibliography{allbib}

\clearpage





\section*{Supplementary Figures \& Tables}

\input{SIfig.tex}





\end{document}